"""
Mayhem Exploitation Engine - Unified engine for all Mayhem Mode exploitation strategies.

This engine coordinates:
- Mayhem Mode detection
- MEV exploitation
- Liquidity blackholing monitoring
- Burn window tracking
"""

import asyncio
from dataclasses import dataclass
from datetime import datetime
from typing import Any, Dict, List, Optional

from core.client import SolanaClient
from defense.mev_shield import RealTimeMEVShield
from exploitation.burn_window import BurnWindowTracker
from exploitation.liquidity_blackholing import LiquidityBlackholingDetector
from exploitation.mayhem_detector import MayhemDetector, MayhemTokenInfo
from exploitation.mayhem_mev import MayhemMEVExploit
from interfaces.core import TokenInfo
from utils.logger import get_logger

logger = get_logger(__name__)


@dataclass
class MayhemExploitationResult:
    """Result of Mayhem Mode exploitation analysis."""

    is_mayhem_mode: bool
    mayhem_info: Optional[MayhemTokenInfo] = None
    should_trade: bool = False
    exploitation_strategy: Optional[str] = None
    recommendations: List[str] = None
    risk_level: str = "unknown"


class MayhemExploitationEngine:
    """
    Unified engine for Mayhem Mode exploitation.

    Coordinates all Mayhem Mode components to provide comprehensive
    exploitation strategies and risk management.
    """

    def __init__(
        self,
        client: SolanaClient,
        mev_shield: Optional[RealTimeMEVShield] = None,
        enable_mev_exploitation: bool = True,
        enable_liquidity_monitoring: bool = True,
        enable_burn_tracking: bool = True,
    ):
        """Initialize the Mayhem exploitation engine.

        Args:
            client: Solana RPC client
            mev_shield: MEV protection shield
            enable_mev_exploitation: Enable MEV exploitation
            enable_liquidity_monitoring: Enable liquidity blackholing monitoring
            enable_burn_tracking: Enable burn window tracking
        """
        self.client = client
        self.mev_shield = mev_shield
        self.enable_mev_exploitation = enable_mev_exploitation
        self.enable_liquidity_monitoring = enable_liquidity_monitoring
        self.enable_burn_tracking = enable_burn_tracking

        # Initialize components
        self.detector = MayhemDetector(client)
        self.mev_exploit = MayhemMEVExploit(
            client, mev_shield, enable_mempool_monitoring=enable_mev_exploitation
        )
        self.liquidity_detector = LiquidityBlackholingDetector(client)
        self.burn_tracker = BurnWindowTracker(exit_before_burn_minutes=30)

        self.active_positions: Dict[str, Dict[str, Any]] = {}

    async def analyze_token(self, token_info: TokenInfo) -> MayhemExploitationResult:
        """Analyze a token for Mayhem Mode exploitation opportunities.

        Args:
            token_info: Token information to analyze

        Returns:
            Mayhem exploitation result
        """
        logger.info(f"Analyzing {token_info.symbol} for Mayhem Mode...")

        # Step 1: Detect Mayhem Mode
        mayhem_info = await self.detector.detect_mayhem_mode(token_info)

        if not mayhem_info.is_mayhem_mode:
            return MayhemExploitationResult(
                is_mayhem_mode=False,
                should_trade=False,
                recommendations=["Not a Mayhem Mode token"],
                risk_level="unknown",
            )

        # Step 2: Analyze exploitation opportunities
        recommendations: List[str] = []
        exploitation_strategy: Optional[str] = None
        should_trade = False
        risk_level = "medium"

        # Check MEV opportunities
        if self.enable_mev_exploitation:
            mev_opportunities = await self.mev_exploit.monitor_mempool(mayhem_info)
            if mev_opportunities:
                exploitation_strategy = "mev_exploitation"
                recommendations.append(f"MEV opportunities detected: {len(mev_opportunities)}")
                should_trade = True

        # Check liquidity blackholing
        if self.enable_liquidity_monitoring and mayhem_info.bot_wallet:
            bot_activity = await self.detector.monitor_bot_activity(mayhem_info)
            drain_analysis = await self.liquidity_detector.analyze_drain(
                mayhem_info, bot_activity
            )

            if drain_analysis.should_exit:
                recommendations.append(f"⚠️ {drain_analysis.exit_reason}")
                risk_level = drain_analysis.exhaustion_risk
                if drain_analysis.exhaustion_risk in ["high", "critical"]:
                    should_trade = False  # Don't enter if liquidity is draining
            else:
                recommendations.append(
                    f"Liquidity drain: {drain_analysis.drain_rate*100:.1f}% "
                    f"({drain_analysis.exhaustion_risk} risk)"
                )

        # Check burn window
        if self.enable_burn_tracking:
            # Use token creation time (approximate if not available)
            token_created_at = token_info.created_at if hasattr(token_info, 'created_at') else datetime.utcnow()
            burn_info = self.burn_tracker.track_token(mayhem_info, token_created_at)

            if burn_info.should_exit_before_burn:
                recommendations.append(
                    f"⚠️ Exit recommended: {burn_info.time_remaining_seconds/3600:.1f}h until burn"
                )
                risk_level = "high"
            else:
                recommendations.append(
                    f"Burn window: {burn_info.percentage_remaining*100:.1f}% remaining "
                    f"({burn_info.time_remaining_seconds/3600:.1f}h)"
                )

        # Determine if we should trade
        if not should_trade and risk_level in ["low", "medium"]:
            # Safe to trade if risk is acceptable
            should_trade = True
            exploitation_strategy = "standard_trading"

        result = MayhemExploitationResult(
            is_mayhem_mode=True,
            mayhem_info=mayhem_info,
            should_trade=should_trade,
            exploitation_strategy=exploitation_strategy,
            recommendations=recommendations,
            risk_level=risk_level,
        )

        logger.info(
            f"Mayhem Mode analysis complete: {token_info.symbol} "
            f"(strategy: {exploitation_strategy}, risk: {risk_level})"
        )

        return result

    async def monitor_position(
        self, token_mint: str, mayhem_info: MayhemTokenInfo
    ) -> Dict[str, Any]:
        """Monitor an active Mayhem Mode position.

        Args:
            token_mint: Token mint address
            mayhem_info: Mayhem token information

        Returns:
            Monitoring results with exit recommendations
        """
        logger.debug(f"Monitoring Mayhem position: {token_mint}...")

        monitoring_results: Dict[str, Any] = {
            "should_exit": False,
            "exit_reasons": [],
            "risk_level": "low",
        }

        # Monitor liquidity blackholing
        if self.enable_liquidity_monitoring and mayhem_info.bot_wallet:
            bot_activity = await self.detector.monitor_bot_activity(mayhem_info)
            drain_analysis = await self.liquidity_detector.monitor_token(
                mayhem_info, bot_activity
            )

            if drain_analysis.should_exit:
                monitoring_results["should_exit"] = True
                monitoring_results["exit_reasons"].append(drain_analysis.exit_reason)
                monitoring_results["risk_level"] = drain_analysis.exhaustion_risk

        # Monitor burn window
        if self.enable_burn_tracking:
            burn_info = self.burn_tracker.get_burn_info(token_mint)
            if burn_info and burn_info.should_exit_before_burn:
                monitoring_results["should_exit"] = True
                monitoring_results["exit_reasons"].append(
                    f"Burn window: {burn_info.time_remaining_seconds/3600:.1f}h remaining"
                )
                if monitoring_results["risk_level"] == "low":
                    monitoring_results["risk_level"] = "high"

        # Store monitoring results
        self.active_positions[token_mint] = {
            "mayhem_info": mayhem_info,
            "monitoring": monitoring_results,
            "last_update": datetime.utcnow(),
        }

        return monitoring_results

    def get_summary(self) -> Dict[str, Any]:
        """Get summary of Mayhem exploitation engine.

        Returns:
            Summary dictionary
        """
        detector_summary = self.detector.get_summary()
        mev_stats = self.mev_exploit.get_statistics()
        liquidity_summary = self.liquidity_detector.get_summary()
        burn_summary = self.burn_tracker.get_summary()

        return {
            "mayhem_tokens_detected": detector_summary["total_detected"],
            "mev_opportunities": mev_stats["total_opportunities"],
            "mev_profit": mev_stats["total_profit"],
            "liquidity_monitoring": liquidity_summary,
            "burn_tracking": burn_summary,
            "active_positions": len(self.active_positions),
            "components_enabled": {
                "mev_exploitation": self.enable_mev_exploitation,
                "liquidity_monitoring": self.enable_liquidity_monitoring,
                "burn_tracking": self.enable_burn_tracking,
            },
        }

